<!-- page2.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Link Sharing Chat w/ Score Panel</title>
<style>
  body { max-width: 900px; margin: 40px auto; font-family: sans-serif; background: #e5e5e5; }
  .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
  #linkInput { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
  #sendBtn { padding: 10px 20px; background: #ffe066; border:none; border-radius: 6px; cursor: pointer; }
  #chat { list-style: none; padding: 0; background: #fff; border-radius: 8px; }
  #chat li { padding: 8px; border-bottom: 1px solid #ddd; }
  .user-badge { font-weight: bold; color: rgb(4,9,71); margin-right: 8px; }
  .secure-link { color: blue; text-decoration: underline; cursor: pointer; }
  .meta { font-size: 0.8rem; color: #777; }

  /* 좌측 점수패널 */
  #scorePanel {
    position: fixed;
    left: 10px;
    top: 115px;
    width: 180px;
    background: #fafafa;
    border-right: 2px solid #ddd;
    padding: 10px;
    height: 80vh;
    overflow-y: auto;
    font-size: 0.85rem;
  }
  #scorePanel h3 { margin: 0 0 8px 0; font-size: 0.95rem; color:#333; }
  #scoreList { list-style:none; margin:0; padding:0;}
  #scoreList li { margin-bottom:8px; border-bottom:1px solid #ddd; padding-bottom:6px;}
  .score-addr { font-weight:bold; color:#0066cc; font-size:0.8rem; word-break: break-all; }

  /* 투표 UI 섹션 추가 */
  #voteSection {
    margin: 20px 0;
    background: #fff;
    padding: 12px;
    border-radius: 10px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.1);
  }
  #voteSection h3 {
    margin-top: 0;
    color: rgb(4,9,71);
  }
  #voteSection input {
    width: 100%;
    padding: 8px;
    margin-bottom: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #voteSection button {
    padding: 8px 16px;
    margin-right: 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    color: white;
  }
  #approveBtn {
    background-color: #0070f3;
  }
  #rejectBtn {
    background-color: #e53e3e;
  }
  #voteStatus {
    margin-top: 10px;
    font-weight: bold;
    color: #333;
  }
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Excel Sync Link Sharing + 점수 패널</h1>

<!-- 좌측 점수 패널 -->
<div id="scorePanel">
  <h3>📊 점수 현황</h3>
  <ul id="scoreList"></ul>
</div>

<div class="input-group">
  <input id="linkInput" type="url" placeholder="https://example.com" />
  <button id="sendBtn">Send Link</button>
</div>

<ul id="chat"></ul>

<!-- 투표 UI 섹션 -->
<div id="voteSection">
  <h3>신규 멤버 승인 투표</h3>
  <label for="candidateInput">신규 멤버 주소 입력</label>
  <input type="text" id="candidateInput" placeholder="0x 주소를 입력하세요" />
  <button id="approveBtn">찬성</button>
  <button id="rejectBtn">반대</button>
  <p id="voteStatus"></p>
</div>

<script type="module">
import { sendOnChainClick, listenClickEvents,
         getCertification, getPersonalRelScore } from './dapp.js';
import { submitVote } from './vote.js';

const socket = io();
const chatEl  = document.getElementById('chat');
const inputEl = document.getElementById('linkInput');
const sendBtn = document.getElementById('sendBtn');
const walletAdr = (localStorage.getItem('walletAddress') || '지갑없음').toLowerCase();

const scoreListEl = document.getElementById('scoreList');
const memberSet = new Set();

// 투표 UI 아이템
const approveBtn = document.getElementById('approveBtn');
const rejectBtn = document.getElementById('rejectBtn');
const candidateInput = document.getElementById('candidateInput');
const voteStatus = document.getElementById('voteStatus');

async function updateScorePanel(addr) {
  try {
    const cert = await getCertification(addr);
    const personal = await getPersonalRelScore(addr);
    let li = document.querySelector(`[data-score="${addr.toLowerCase()}"]`);
    if (!li) {
      li = document.createElement('li');
      li.dataset.score = addr.toLowerCase();
      scoreListEl.appendChild(li);
    }
    li.innerHTML = `
      <span class="score-addr">${addr}</span><br>
      🔑 인증점수: ${cert.toFixed(2)}<br>
      🤝 개인관계점수: ${personal.toFixed(2)}`;
  } catch (e) {
    console.error("점수 업데이트 실패", e);
  }
}

function addLinkToChat({ link, wallet, time }) {
  const li = document.createElement('li');
  const a = document.createElement('a');
  a.className = 'secure-link';
  a.href = link;
  a.textContent = link;
  a.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await sendOnChainClick(link, wallet);
      await updateScorePanel(wallet);
    } catch (err) {
      alert("온체인 click 실패: " + (err?.message || err));
    }
    window.open(link, '_blank');
  });

  li.innerHTML = `<span class="user-badge">${wallet}</span>`;
  li.appendChild(a);
  const metaDiv = document.createElement('div');
  metaDiv.className = 'meta';
  metaDiv.textContent = time;
  li.appendChild(metaDiv);
  chatEl.appendChild(li);

  if (!memberSet.has(wallet)) {
    memberSet.add(wallet);
    updateScorePanel(wallet);
  }
}

// 내 지갑 주소 점수 언제나 표시 보장
function ensureMyScoreVisible() {
  if (walletAdr && walletAdr !== '지갑없음' && !memberSet.has(walletAdr)) {
    memberSet.add(walletAdr);
    updateScorePanel(walletAdr);
  }
}

socket.on('initData', (links) => {
  chatEl.innerHTML = '';
  scoreListEl.innerHTML = '';
  memberSet.clear();
  links.forEach(addLinkToChat);
  ensureMyScoreVisible();
});

socket.on('newLink', (data) => {
  addLinkToChat(data);
  ensureMyScoreVisible();
});

sendBtn.addEventListener('click', () => {
  const url = inputEl.value.trim();
  if (!url) return alert('URL을 입력하세요');
  socket.emit('newLink', { link: url, wallet: walletAdr });
  inputEl.value = '';
  ensureMyScoreVisible();
});

listenClickEvents(async () => {
  for (const addr of memberSet) {
    updateScorePanel(addr);
  }
  ensureMyScoreVisible();
});

window.addEventListener('DOMContentLoaded', ensureMyScoreVisible);

// --- 투표 UI 이벤트 처리 ---
let verifier = walletAdr;

approveBtn.addEventListener('click', async () => {
  const candidate = candidateInput.value.trim().toLowerCase();
  if (!candidate) return alert('신규 멤버 주소를 입력하세요');
  if (!verifier) {
    // 지갑 없는 경우 연결 요구(간단 처리)
    try {
      verifier = (await import('./dapp.js')).connectWallet();
      localStorage.setItem('walletAddress', verifier);
    } catch (err) {
      return alert('지갑을 연결해야 투표할 수 있습니다.');
    }
  }
  try {
    await submitVote(candidate, verifier, true);
    voteStatus.textContent = '찬성 투표 완료';
  } catch (e) {
    voteStatus.textContent = '투표 실패: ' + e.message;
  }
});

rejectBtn.addEventListener('click', async () => {
  const candidate = candidateInput.value.trim().toLowerCase();
  if (!candidate) return alert('신규 멤버 주소를 입력하세요');
  if (!verifier) {
    try {
      verifier = (await import('./dapp.js')).connectWallet();
      localStorage.setItem('walletAddress', verifier);
    } catch (err) {
      return alert('지갑을 연결해야 투표할 수 있습니다.');
    }
  }
  try {
    await submitVote(candidate, verifier, false);
    voteStatus.textContent = '반대 투표 완료';
  } catch (e) {
    voteStatus.textContent = '투표 실패: ' + e.message;
  }
});
</script>
</body>
</html>
