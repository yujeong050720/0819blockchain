<!-- page2.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Link Sharing Chat w/ Score Panel</title>
  <style>
    body { max-width: 900px; margin: 40px auto; font-family: sans-serif; background: #e5e5e5; }
    .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
    #linkInput { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    #sendBtn { padding: 10px 20px; background: #ffe066; border:none; border-radius: 6px; cursor: pointer; }
    #chat { list-style: none; padding: 0; background: #fff; border-radius: 8px; }
    #chat li { padding: 8px; border-bottom: 1px solid #ddd; }
    .user-badge { font-weight: bold; color: rgb(4,9,71); margin-right: 8px; }
    .secure-link { color: blue; text-decoration: underline; cursor: pointer; }
    .meta { font-size: 0.8rem; color: #777; }

    /* ì¢Œì¸¡ ì ìˆ˜íŒ¨ë„ */
    #scorePanel {
      position: fixed;
      left: 10px;
      top: 115px;
      width: 180px;
      background: #fafafa;
      border-right: 2px solid #ddd;
      padding: 10px;
      height: 80vh;
      overflow-y: auto;
      font-size: 0.85rem;
    }
    #scorePanel h3 { margin: 0 0 8px 0; font-size: 0.95rem; color:#333; }
    #scoreList { list-style:none; margin:0; padding:0;}
    #scoreList li { margin-bottom:8px; border-bottom:1px solid #ddd; padding-bottom:6px;}
    .score-addr { font-weight:bold; color:#0066cc; font-size:0.8rem; word-break: break-all; }

    /* íˆ¬í‘œ UI ì„¹ì…˜ ì¶”ê°€ */
    #voteSection {
      margin: 20px 0;
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    #voteSection h3 {
      margin-top: 0;
      color: rgb(4,9,71);
    }
    #voteSection button {
      padding: 8px 16px;
      margin-right: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      color: white;
    }
    #approveBtn { background-color: #0070f3; }
    #rejectBtn { background-color: #e53e3e; }
    #voteStatus {
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1>Excel Sync Link Sharing + ì ìˆ˜ íŒ¨ë„</h1>

  <!-- ì¢Œì¸¡ ì ìˆ˜ íŒ¨ë„ -->
  <div id="scorePanel">
    <h3>ğŸ“Š ì ìˆ˜ í˜„í™©</h3>
    <ul id="scoreList"></ul>
  </div>

  <div class="input-group">
    <input id="linkInput" type="url" placeholder="https://example.com" />
    <button id="sendBtn">Send Link</button>
  </div>

  <ul id="chat"></ul>

  <!-- íˆ¬í‘œ UI ì„¹ì…˜ -->
  <div id="voteSection">
    <h3>ì‹ ê·œ ë©¤ë²„ ìŠ¹ì¸ íˆ¬í‘œ</h3>
    <button id="approveBtn">ì°¬ì„±</button>
    <button id="rejectBtn">ë°˜ëŒ€</button>
    <p id="voteStatus"></p>
  </div>

  <script type="module">
    import { sendOnChainClick, listenClickEvents,
             getCertification, getPersonalRelScore } from './dapp.js';

    const socket = io();
    const chatEl  = document.getElementById('chat');
    const inputEl = document.getElementById('linkInput');
    const sendBtn = document.getElementById('sendBtn');
    const walletAdr = (localStorage.getItem('walletAddress') || 'ì§€ê°‘ì—†ìŒ').toLowerCase();

    const scoreListEl = document.getElementById('scoreList');
    const memberSet = new Set();

    const approveBtn = document.getElementById('approveBtn');
    const rejectBtn = document.getElementById('rejectBtn');
    const voteStatus = document.getElementById('voteStatus');

    let currentCandidate = null; // ì„œë²„ì—ì„œ ë°›ì€ í›„ë³´ì

    // ì ìˆ˜ íŒ¨ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateScorePanel(addr) {
      try {
        const cert = await getCertification(addr);
        const personal = await getPersonalRelScore(addr);
        let li = document.querySelector(`[data-score="${addr.toLowerCase()}"]`);
        if (!li) {
          li = document.createElement('li');
          li.dataset.score = addr.toLowerCase();
          scoreListEl.appendChild(li);
        }
        li.innerHTML = `
          <span class="score-addr">${addr}</span><br>
          ğŸ”‘ ì¸ì¦ì ìˆ˜: ${cert.toFixed(2)}<br>
          ğŸ¤ ê°œì¸ê´€ê³„ì ìˆ˜: ${personal.toFixed(2)}`;
      } catch (e) {
        console.error("ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", e);
      }
    }

    // ì±„íŒ…ì°½ì— ë§í¬ ì¶”ê°€ í•¨ìˆ˜
    function addLinkToChat({ link, wallet, time }) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.className = 'secure-link';
      a.href = link;
      a.textContent = link;
      a.addEventListener('click', async (e) => {
        e.preventDefault();
        try {
          await sendOnChainClick(link, wallet);
          await updateScorePanel(wallet);
        } catch (err) {
          alert("ì˜¨ì²´ì¸ click ì‹¤íŒ¨: " + (err?.message || err));
        }
        window.open(link, '_blank');
      });
      li.innerHTML = `<span class="user-badge">${wallet}</span>`;
      li.appendChild(a);
      const metaDiv = document.createElement('div');
      metaDiv.className = 'meta';
      metaDiv.textContent = time;
      li.appendChild(metaDiv);
      chatEl.appendChild(li);

      if (!memberSet.has(wallet)) {
        memberSet.add(wallet);
        updateScorePanel(wallet);
      }
    }

    function ensureMyScoreVisible() {
      if (walletAdr && walletAdr !== 'ì§€ê°‘ì—†ìŒ' && !memberSet.has(walletAdr)) {
        memberSet.add(walletAdr);
        updateScorePanel(walletAdr);
      }
    }

    // ì„œë²„ ì´ˆê¸° ë°ì´í„° ë°›ê¸°
    socket.on('initData', (links) => {
      chatEl.innerHTML = '';
      scoreListEl.innerHTML = '';
      memberSet.clear();
      links.forEach(addLinkToChat);
      ensureMyScoreVisible();
    });

    // ìƒˆë¡œìš´ ë§í¬ ë°›ì„ ë•Œ
    socket.on('newLink', (data) => {
      addLinkToChat(data);
      ensureMyScoreVisible();
    });

    sendBtn.addEventListener('click', () => {
      const url = inputEl.value.trim();
      if (!url) return alert('URLì„ ì…ë ¥í•˜ì„¸ìš”');
      socket.emit('newLink', { link: url, wallet: walletAdr });
      inputEl.value = '';
      ensureMyScoreVisible();
    });

    listenClickEvents(async () => {
      for (const addr of memberSet) {
        updateScorePanel(addr);
      }
      ensureMyScoreVisible();
    });

    window.addEventListener('DOMContentLoaded', ensureMyScoreVisible);

    // --- ì„œë²„ì—ì„œ í›„ë³´ì ì•Œë¦¼ ---
    socket.on('newUserAlert', (data) => {
      currentCandidate = data.wallet.toLowerCase();
      voteStatus.textContent = `ì‹ ê·œ ë©¤ë²„ ìŠ¹ì¸ ìš”ì²­: ${currentCandidate}`;
    });

    // --- íˆ¬í‘œ ë²„íŠ¼ ì´ë²¤íŠ¸ (ì„œë²„ë¡œ ì „ì†¡) ---
    approveBtn.addEventListener('click', () => {
      if (!currentCandidate) return alert('ìŠ¹ì¸í•  í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.');
      socket.emit('vote', { candidate: currentCandidate, verifier: walletAdr, approve: true });
      voteStatus.textContent = 'ì°¬ì„± íˆ¬í‘œ ì „ì†¡ ì™„ë£Œ';
      currentCandidate = null;
    });

    rejectBtn.addEventListener('click', () => {
      if (!currentCandidate) return alert('íˆ¬í‘œí•  í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.');
      socket.emit('vote', { candidate: currentCandidate, verifier: walletAdr, approve: false });
      voteStatus.textContent = 'ë°˜ëŒ€ íˆ¬í‘œ ì „ì†¡ ì™„ë£Œ';
      currentCandidate = null;
    });

    // --- ì„œë²„ë¡œë¶€í„° ìŠ¹ì¸/ê±°ì ˆ ì•Œë¦¼ ë°›ê¸° ---
    socket.on('verificationCompleted', (data) => {
      if (data.candidate && data.candidate.toLowerCase() === walletAdr.toLowerCase()) {
        if (data.approved) {
          alert("ì‹ ê·œ ë©¤ë²„ ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        } else {
          alert("ì‹ ê·œ ë©¤ë²„ ìŠ¹ì¸ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      }
    });

  </script>
</body>
</html>
